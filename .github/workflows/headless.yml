name: Hyprland Headless (Arch)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Update System & Install Dependencies
        run: |
          pacman -Syu --noconfirm
          # Install development tools and dependencies
          # hyprland package in Arch usually includes headers and pkg-config files
          pacman -S --noconfirm \
            hyprland

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Hyprland Headless
        run: |
          export HOME=/root
          mkdir -p $HOME
          
          # Create Hyprland config directory and minimal config
          mkdir -p $HOME/.config/hypr
          cat > $HOME/.config/hypr/hyprland.conf << 'EOF'
          # Minimal headless config
          monitor=WL-1,1920x1080@60,0x0,1
          
          exec-once = echo "Hyprland started" && sleep 5 && hyprctl dispatch exit
          EOF
          
          # Setup XDG runtime directory
          mkdir -p /tmp/hyprland-runtime
          export XDG_RUNTIME_DIR=/tmp/hyprland-runtime
          chmod 700 $XDG_RUNTIME_DIR
          
          # Create cache directory for crash reports
          mkdir -p $HOME/.cache/hyprland
          mkdir -p /tmp/hypr
          
          # Set headless backend environment variables
          export WLR_BACKENDS=headless
          export WLR_LIBINPUT_NO_DEVICES=1
          export WLR_RENDERER=pixman
          
          # Run Hyprland
          Hyprland 2>&1 || echo "Hyprland exited with code $?"