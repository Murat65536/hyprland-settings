name: Hyprland Headless (Arch)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Update System & Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            hyprland \
            base-devel \
            xorg-server-xvfb \
            xorg-xwayland \
            mesa \
            pixman


      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup virtual DRM device
        run: |
          sudo modprobe vkms || true
          # Create dummy DRM device if needed
          sudo mkdir -p /dev/dri
          sudo mknod /dev/dri/card0 c 226 0 || true
          sudo chmod 666 /dev/dri/card0 || true
    
      - name: Run Hyprland headless
        run: |
          # Set environment variables
          mkdir -p /tmp/runtime-dir
          chmod 700 /tmp/runtime-dir
          export XDG_RUNTIME_DIR=/tmp/runtime-dir
          export LIBSEAT_BACKEND=noop
          export WLR_BACKENDS=headless
          export WLR_RENDERER=pixman
          export WLR_RENDERER_ALLOW_SOFTWARE=1
          export AQ_NO_MODIFIERS=1
          export WLR_NO_HARDWARE_CURSORS=1
          export HYPRLAND_NO_RT=1
          export HYPRLAND_NO_SD_NOTIFY=1
        
          # Run Hyprland in background
          start-hyprland -- --i-am-really-stupid &
          HYPRLAND_PID=$!
        
          # Wait for it to start
          sleep 3
        
          # Your tests here
        
          # Cleanup
          kill $HYPRLAND_PID || true
          cat /home/.cache/hyprland/hyprlandCrashReport*.txt