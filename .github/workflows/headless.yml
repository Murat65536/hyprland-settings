name: Hyprland Headless (Arch)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Update System & Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            hyprland \
            mesa \
            vulkan-swrast \
            vulkan-icd-loader \
            mesa-utils

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Hyprland Headless
        run: |
          export HOME=/home
          mkdir -p $HOME

          mkdir -p /tmp/hyprland-runtime
          export XDG_RUNTIME_DIR=/tmp/hyprland-runtime
          chmod 700 $XDG_RUNTIME_DIR
          
          mkdir -p $HOME/.cache/hyprland
          mkdir -p /tmp/hypr
          mkdir -p $HOME/.config/hypr

          # Create a minimal config for headless
          echo "monitor = HEADLESS-1, 1920x1080, auto, 1" > $HOME/.config/hypr/hyprland.conf
          echo "env = AQ_BACKEND,headless" >> $HOME/.config/hypr/hyprland.conf
          
          # Configuration for Headless & CI environment
          export AQ_BACKEND=headless
          export AQ_TRACE=1
          export AQ_NO_MODIFIERS=1
          export HYPRLAND_HEADLESS_ONLY=1
          
          # Bypass seat requirement (fixes libseat panic in container)
          export LIBSEAT_BACKEND=noop
          
          # Force software rendering (llvmpipe) for stability
          export MESA_LOADER_DRIVER_OVERRIDE=llvmpipe

          # Debug environment
          echo "Checking /dev/dri:"
          ls -la /dev/dri || echo "/dev/dri not found"
          
          echo "Checking env:"
          env | grep -E "AQ_|HYPR|WLR|MESA"

          Hyprland --i-am-really-stupid 2>&1 || echo "Hyprland exited with code $?"

          cat /home/.cache/hyprland/hyprlandCrashReport*.txt