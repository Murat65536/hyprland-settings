name: Hyprland Headless (Arch)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Update System & Install Dependencies
        run: |
          pacman -Syu --noconfirm
          # Install development tools and dependencies
          # hyprland package in Arch usually includes headers and pkg-config files
          pacman -S --noconfirm \
            base-devel \
            git \
            cmake \
            meson \
            pkgconf \
            hyprland \
            gtkmm-4.0 \
            wayland \
            wayland-protocols

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Hyprland Install
        run: |
          hyprctl version || true
          pkg-config --cflags hyprland
          ls -la /usr/include/hyprland || echo "Headers not found in standard path"

      - name: Build hyprland-settings
        run: |
          # Build plugin
          # We might need to tell make where to find headers if pkg-config fails or is weird,
          # but usually standard Arch packages are well-behaved.
          cd update
          make
          
          # Build GUI
          cd ../gui
          make

      - name: Run Hyprland Headless
        run: |
          # Create a dummy config to avoid first-run warnings/errors
          mkdir -p ~/.config/hypr
          touch ~/.config/hypr/hyprland.conf
          
          # Set runtime variables for headless
          export WLR_BACKENDS=headless
          export WLR_LIBINPUT_NO_DEVICES=1
          
          # Start Hyprland in the background
          Hyprland &
          HYPR_PID=$!
          
          # Wait a few seconds for startup
          sleep 5
          
          # Check if process is still alive
          if kill -0 $HYPR_PID; then
            echo "SUCCESS: Hyprland is running."
            kill $HYPR_PID
          else
            echo "FAILURE: Hyprland crashed or failed to start."
            exit 1
          fi