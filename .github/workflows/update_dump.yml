name: Update Hyprland Settings Dump

on:
  schedule:
    # Run at 00:00 on Sunday
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-dump:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    permissions:
      contents: write

    steps:
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          # Install Hyprland and Xvfb for headless X11 server
          pacman -S --noconfirm base-devel cmake ninja git hyprland wayland-protocols pkg-config mesa vulkan-swrast llvm libglvnd seatd xorg-server-xvfb

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build Plugin
        run: |
          echo "Hyprland CFLAGS: $(pkg-config --cflags hyprland)"
          g++ -shared -fPIC --no-gnu-unique -std=c++23 -O2 $(pkg-config --cflags hyprland) update/main.cpp -o hyprland_settings_plugin.so

      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          # Install Hyprland, Wayfire (for headless host), and dependencies
          pacman -S --noconfirm base-devel cmake ninja git hyprland wayland-protocols pkg-config mesa vulkan-swrast llvm libglvnd seatd xorg-xwayland wayfire wayfire-plugins-extra dbus mesa-utils

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build Plugin
        run: |
          echo "Hyprland CFLAGS: $(pkg-config --cflags hyprland)"
          g++ -shared -fPIC --no-gnu-unique -std=c++23 -O2 $(pkg-config --cflags hyprland) update/main.cpp -o hyprland_settings_plugin.so

      - name: Run Hyprland and Generate Dump
        timeout-minutes: 2
        run: |
          # Setup directories
          export XDG_RUNTIME_DIR=/tmp/hypr-runtime
          export HOME=/tmp/hypr-home
          export XDG_CACHE_HOME=/tmp/hypr-cache
          mkdir -p $XDG_RUNTIME_DIR $HOME $XDG_CACHE_HOME
          chmod 700 $XDG_RUNTIME_DIR

          # Start Wayfire (Headless Host)
          # Wayfire often supports more protocols than Weston, satisfying Aquamarine's requirements
          echo "Starting Wayfire..."
          export WAYLAND_DISPLAY=wayland-1
          export WLR_BACKENDS=headless
          export WLR_LIBINPUT_NO_DEVICES=1
          export WLR_RENDERER=pixman # Use software rendering for Wayfire too
          
          # Basic Wayfire config
          mkdir -p $HOME/.config
          echo "[core]" > $HOME/.config/wayfire.ini
          echo "plugins = " >> $HOME/.config/wayfire.ini
          echo "[output:WL-1]" >> $HOME/.config/wayfire.ini
          echo "mode = 1920x1080@60" >> $HOME/.config/wayfire.ini
          
          wayfire &
          WAYFIRE_PID=$!
          
          # Wait for Wayfire
          echo "Waiting for Wayland socket..."
          for i in {1..10}; do
            if [ -S "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" ]; then
              echo "Socket found!"
              break
            fi
            sleep 1
          done
          
          if [ ! -S "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" ]; then
            echo "Failed to start Wayfire"
            exit 1
          fi

          # Prepare Hyprland Environment
          # Unset backend variables so Hyprland detects the Wayland session
          unset WLR_BACKENDS
          unset WLR_LIBINPUT_NO_DEVICES
          
          # Force software rendering for Hyprland (nested)
          export LIBGL_ALWAYS_SOFTWARE=1
          export GALLIUM_DRIVER=llvmpipe
          export AQ_TRACE=1
          
          # Hyprland Config
          PLUGIN_PATH=$(pwd)/hyprland_settings_plugin.so
          echo "plugin = $PLUGIN_PATH" > hyprland.conf
          echo "misc:disable_hyprland_logo = true" >> hyprland.conf
          
          echo "Starting Hyprland..."
          # Run Hyprland nested inside Wayfire
          timeout 15s Hyprland --i-am-really-stupid --config hyprland.conf || true
          
          # Cleanup
          kill $WAYFIRE_PID || true
          
          if [ -f "hyprland_settings_dump.txt" ]; then
            echo "Dump file generated successfully."
            cat hyprland_settings_dump.txt | head -n 10
          else
            echo "Error: Dump file was not generated."
            ls -R $HOME
            # Check for Hyprland logs
            find $XDG_CACHE_HOME -name "hyprland*" -exec cat {} +
            exit 1
          fi

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update hyprland settings dump [skip ci]"
          file_pattern: hyprland_settings_dump.txt
