name: Update Hyprland Settings Dump

on:
  schedule:
    # Run at 00:00 on Sunday
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-dump:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    permissions:
      contents: write

    steps:
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel cmake ninja git hyprland wayland-protocols pkg-config

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Debug File Structure
        run: |
          echo "Current Directory: $(pwd)"
          ls -R

      - name: Build Plugin
        run: |
          # Build using the headers provided by the arch package
          g++ -shared -fPIC --no-gnu-unique -std=c++23 -O2 \n            $(pkg-config --cflags hyprland) \n            main.cpp -o hyprland_settings_plugin.so

      - name: Run Hyprland and Generate Dump
        timeout-minutes: 1
        env:
          WLR_BACKENDS: headless
          WLR_RENDERER: pixman
          WLR_LIBINPUT_NO_DEVICES: 1
          XDG_RUNTIME_DIR: /tmp
        run: |
          # Create a minimal config that loads the plugin
          echo "plugin = $(pwd)/hyprland_settings_plugin.so" > hyprland.conf
          
          # Run Hyprland with a timeout
          timeout 10s Hyprland -c hyprland.conf || true
          
          # Check if file exists
          if [ -f "hyprland_settings_dump.txt" ]; then
            echo "Dump file generated successfully."
            cat hyprland_settings_dump.txt | head -n 10
          else
            echo "Error: Dump file was not generated."
            ls -R
            exit 1
          fi

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update hyprland settings dump [skip ci]"
          file_pattern: hyprland_settings_dump.txt
